---
const {
  pairs = [], // e.g., ['USD-PHP','USD-MXN'] — empty shows curated defaults
  apiUrl = 'https://open.er-api.com/v6/latest',
  refreshMs = 120_000,
} = Astro.props;
const cfg = {
  pairs,
  apiUrl,
  refreshMs: Number(refreshMs) || 120000,
  flagMap: { USD: 'us', EUR: 'eu', MXN: 'mx', PHP: 'ph', NGN: 'ng', INR: 'in', PKR: 'pk', GBP: 'gb', JPY: 'jp', CHF: 'ch', AUD: 'au', CAD: 'ca', CNY: 'cn' }
};
---
<div class="card" data-rate-table aria-live="polite">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <strong>Rates</strong>
    <span class="pill" data-updated>—</span>
  </div>
  <div style="overflow:auto; margin-top: 10px;">
    <table>
      <thead>
        <tr>
          <th>Pair</th>
          <th>Rate</th>
          <th>Fee</th>
          <th>Delivery</th>
        </tr>
      </thead>
      <tbody data-body>
        <tr><td colspan="4" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
  <div class="muted" style="margin-top:10px; font-size:12px;">Data source: bestexchangerates.com</div>
  <script type="application/json" data-config>{JSON.stringify(cfg)}</script>
  <script>
  (() => {
    function init(root) {
      if (!root || root.dataset.initialized) return;
      root.dataset.initialized = '1';
      const cfgNode = root.querySelector('script[type="application/json"][data-config]');
      let parsed = {};
      try {
        const raw = (cfgNode && cfgNode.textContent) || '{}';
        parsed = JSON.parse(raw);
      } catch (e) {
        console.warn('RateTable config JSON parse failed');
        parsed = {};
      }
      const onlyPairs = parsed.pairs || [];
      const apiUrl = parsed.apiUrl || 'https://open.er-api.com/v6/latest';
      const refreshMs = Number(parsed.refreshMs) || 120000;
      const flagMap = parsed.flagMap || {};

      const body = root.querySelector('[data-body]');
      const updatedEl = root.querySelector('[data-updated]');

      function toFlag(ccy){
        const v = (flagMap && flagMap[ccy]) || ccy.slice(0,2);
        return String(v).toLowerCase();
      }

      async function fetchBase(base) {
        const url = apiUrl.replace(/\/$/, '') + '/' + encodeURIComponent(base);
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      }

      function renderRows(map, timestamp) {
        const frag = document.createDocumentFragment();
        Object.keys(map).sort().forEach((p) => {
          const entry = map[p];
          const [base, quote] = p.split('-');
          const fb = toFlag(base);
          const fq = toFlag(quote);
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>'+
            '<img class="flag" alt="' + base + '" src="https://flagcdn.com/' + fb + '.svg" /> ' +
            '<a href="/rates/' + p + '\">' + p + '</a> ' +
            '<img class="flag" alt="' + quote + '" src="https://flagcdn.com/' + fq + '.svg" />' +
            '</td>' +
            '<td>' + Number(entry.rate).toFixed(4) + '</td>' +
            '<td>$' + Number(entry.fee || 0).toFixed(2) + '</td>' +
            '<td>' + (entry.delivery || '—') + '</td>';
          frag.appendChild(tr);
        });
        body.innerHTML = '';
        body.appendChild(frag);
        const ts = timestamp ? new Date(timestamp * 1000) : new Date();
        updatedEl.textContent = ts.toLocaleString();
      }

      async function refresh() {
        try {
          const list = (onlyPairs && onlyPairs.length) ? onlyPairs : ['USD-PHP','USD-MXN','USD-NGN','EUR-PHP'];
          const bases = Array.from(new Set(list.map((p) => String(p).split('-')[0])));
          const results = await Promise.all(bases.map((b) => fetchBase(b)));
          const byBase = Object.create(null);
          bases.forEach((b, i) => { byBase[b] = results[i]; });
          const map = Object.create(null);
          list.forEach((p) => {
            const [base, quote] = String(p).split('-');
            const data = byBase[base];
            if (!data || !data.rates) return;
            const rate = data.rates[quote];
            if (rate == null) return;
            map[p] = { rate: Number(rate), fee: 0, delivery: 'Varies' };
          });
          const anyTs = results.find(Boolean)?.time_last_update_unix;
          renderRows(map, anyTs);
        } catch (e) {
          console.error('Rate table refresh failed:', e);
        }
      }

      refresh();
      if (refreshMs > 0) setInterval(refresh, refreshMs);
    }

    function boot() {
      document.querySelectorAll('[data-rate-table]').forEach(init);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  })();
  </script>
</div>
