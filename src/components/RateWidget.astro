---
const {
  pair = 'USD-PHP',
  apiUrl = 'https://open.er-api.com/v6/latest',
  refreshMs = 60_000,
  showSelector = false,
  pairsOptions = ['USD-PHP','USD-MXN','USD-NGN','EUR-PHP']
} = Astro.props;

const [base, quote] = String(pair).split('-');
const id = `rate-${base}-${quote}`.toLowerCase();
const FLAG_MAP = {
  USD: 'us', EUR: 'eu', MXN: 'mx', PHP: 'ph', NGN: 'ng', INR: 'in', PKR: 'pk',
  GBP: 'gb', JPY: 'jp', CHF: 'ch', AUD: 'au', CAD: 'ca', CNY: 'cn'
};
const cfg = {
  pair: `${base}-${quote}`,
  apiUrl,
  refreshMs: Number(refreshMs) || 60000,
  showSelector: Boolean(showSelector),
  pairsOptions,
  flagMap: FLAG_MAP
};
---
<div class="card" id={id} aria-live="polite" data-rate-widget>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div style="display:flex; align-items:center; gap:8px;">
      <img class="flag" data-flag-base alt={base} src={`https://flagcdn.com/${(FLAG_MAP[base] || base).toLowerCase()}.svg`} width="18" height="12" />
      <strong style="font-size: 18px;">{base} → {quote}</strong>
      <img class="flag" data-flag-quote alt={quote} src={`https://flagcdn.com/${(FLAG_MAP[quote] || quote).toLowerCase()}.svg`} width="18" height="12" />
      <div class="muted" style="font-size: 12px;">Live rate and quick convert</div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      { showSelector && (
        <select data-pair-select style="min-width: 140px;">
          {pairsOptions.map((p) => <option value={p} selected={p === `${base}-${quote}`}>{p}</option>)}
        </select>
      )}
      <span class="pill" data-updated>—</span>
    </div>
  </div>
  <div style="margin-top: 12px; display:grid; gap:12px; grid-template-columns: 1fr 1fr;">
    <label>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">Amount ({base})</div>
      <input type="number" min="0" step="0.01" value="100" data-amount />
    </label>
    <label>
      <div class="muted" style="font-size:12px; margin-bottom:6px;">You get ({quote})</div>
      <input type="text" readonly data-result />
    </label>
  </div>
  <div style="display:flex; align-items:center; gap:12px; margin-top:12px; flex-wrap:wrap;">
    <span class="pill">Rate: <strong style="margin-left:6px;" data-rate>—</strong></span>
    <span class="pill">Fee: <span style="margin-left:6px;" data-fee>—</span></span>
    <span class="pill">Delivery: <span style="margin-left:6px;" data-delivery>—</span></span>
  </div>
  <div class="muted" style="margin-top:10px; font-size:12px;">Data source: open.er-api.com</div>
  <script type="application/json" data-config>{JSON.stringify(cfg)}</script>
  <script>
  (() => {
    function init(root) {
      if (!root || root.dataset.initialized) return;
      root.dataset.initialized = '1';
      const cfgNode = root.querySelector('script[type="application/json"][data-config]');
      let pair = 'USD-PHP';
      let apiUrl = 'https://open.er-api.com/v6/latest';
      let refreshMs = 60000;
      let showSelector = false;
      let pairsOptions = [];
      let flagMap = {};
      try {
        const raw = (cfgNode && cfgNode.textContent) || '{}';
        const parsed = JSON.parse(raw);
        pair = parsed.pair || pair;
        apiUrl = parsed.apiUrl || apiUrl;
        refreshMs = Number(parsed.refreshMs) || refreshMs;
        showSelector = Boolean(parsed.showSelector);
        pairsOptions = Array.isArray(parsed.pairsOptions) ? parsed.pairsOptions : [];
        flagMap = parsed.flagMap || {};
      } catch (e) {
        console.warn('RateWidget config JSON parse failed');
      }

      const amountEl = root.querySelector('[data-amount]');
      const resultEl = root.querySelector('[data-result]');
      const rateEl = root.querySelector('[data-rate]');
      const feeEl = root.querySelector('[data-fee]');
      const deliveryEl = root.querySelector('[data-delivery]');
      const updatedEl = root.querySelector('[data-updated]');
      const headingEl = root.querySelector('strong');
      const amtLabel = root.querySelector('label:first-child .muted');
      const getLabel = root.querySelector('label:nth-child(2) .muted');
      const selectEl = root.querySelector('[data-pair-select]');
      const flagBase = root.querySelector('[data-flag-base]');
      const flagQuote = root.querySelector('[data-flag-quote]');

      function toFlag(ccy){
        const v = (flagMap && flagMap[ccy]) || ccy.slice(0,2);
        return String(v).toLowerCase();
      }

      async function fetchRates() {
        try {
          const [base] = String(pair).split('-');
          const url = apiUrl.replace(/\/$/, '') + '/' + encodeURIComponent(base);
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (e) {
          console.error('Rate fetch failed:', e);
          return null;
        }
      }

      function updateUI(rateData) {
        if (!rateData) return;
        const [base, quote] = String(pair).split('-');
        const rate = Number(rateData && rateData.rates && rateData.rates[quote]);
        const fee = 0;
        rateEl.textContent = isFinite(rate) ? rate.toFixed(4) : '—';
        feeEl.textContent = '$' + (isFinite(fee) ? fee.toFixed(2) : '0.00');
        deliveryEl.textContent = 'Varies';
        const amt = Number(amountEl.value || 0);
        const result = isFinite(rate) ? amt * rate : 0;
        resultEl.value = result.toFixed(2);
        const ts = rateData.time_last_update_unix ? new Date(rateData.time_last_update_unix * 1000) : new Date();
        updatedEl.textContent = ts.toLocaleString();
        if (headingEl) headingEl.textContent = base + ' → ' + quote;
        if (amtLabel) amtLabel.textContent = 'Amount (' + base + ')';
        if (getLabel) getLabel.textContent = 'You get (' + quote + ')';
        if (flagBase) flagBase.src = 'https://flagcdn.com/' + toFlag(base) + '.svg';
        if (flagBase) flagBase.alt = base;
        if (flagQuote) flagQuote.src = 'https://flagcdn.com/' + toFlag(quote) + '.svg';
        if (flagQuote) flagQuote.alt = quote;
      }

      async function refresh() {
        const data = await fetchRates();
        updateUI(data);
      }

      // Set initial flags immediately
      (function(){
        const [b,q] = String(pair).split('-');
        if (flagBase) flagBase.src = 'https://flagcdn.com/' + toFlag(b) + '.svg';
        if (flagQuote) flagQuote.src = 'https://flagcdn.com/' + toFlag(q) + '.svg';
      })();

      amountEl.addEventListener('input', refresh);
      if (selectEl) {
        selectEl.addEventListener('change', () => {
          const next = selectEl.value;
          if (next && next !== pair) {
            pair = next;
            refresh();
          }
        });
      }
      refresh();
      if (refreshMs > 0) setInterval(refresh, refreshMs);
    }

    function boot() {
      document.querySelectorAll('[data-rate-widget]').forEach(init);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
  })();
  </script>
</div>
